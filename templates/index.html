<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Todo List</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css">
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.min.js"></script>
    <style>
        .task {
            margin-bottom: 10px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .task.completed {
            text-decoration: line-through;
            color: gray;
        }
        .task-priority-high {
            background-color: #f08080; /* Light Red */
        }
        .task-priority-medium {
            background-color: #ffffcc; /* Light Yellow */
        }
        .task-priority-low {
            background-color: #90ee90; /* Light Green */
        }
    </style>
</head>
<body>
<div class="container">
    <h1>Todo List</h1>

    <div class="row">
        <div class="col-md-6">
            <input type="text" id="new-task-title" class="form-control" placeholder="Название задачи">
        </div>
        <div class="col-md-6">
            <textarea id="new-task-description" class="form-control" placeholder="Описание задачи"></textarea>
        </div>
    </div>

    <div class="row mt-2">
        <div class="col-md-3">
            <select id="new-task-priority" class="form-control">
                <option value="1">Высокий</option>
                <option value="2">Средний</option>
                <option value="3">Низкий</option>
            </select>
        </div>
        <div class="col-md-3">
            <button id="add-task" class="btn btn-primary">Добавить задачу</button>
        </div>
        <div class="col-md-3">
            <button id="refresh-tasks" class="btn btn-secondary">Обновить</button>
        </div>
        <div class="col-md-3">
            <select id="sort-tasks" class="form-control">
                <option value="none">Без сортировки</option>
                <option value="date">По дате</option>
                <option value="status">По статусу</option>
                <option value="priority">По приоритету</option>
            </select>
        </div>
    </div>

    <div class="row mt-2">
        <div class="col-md-3">
            <button id="filter-completed" class="btn btn-success">Показать завершенные</button>
        </div>
        <div class="col-md-3">
            <button id="filter-not-completed" class="btn btn-warning">Показать незавершенные</button>
        </div>
        <div class="col-md-3">
            <button id="filter-all" class="btn btn-info">Показать все</button>
        </div>
    </div>

    <div id="task-list" class="mt-3">
        <!-- Задачи будут отображаться здесь -->
    </div>
</div>

<script>
    $(document).ready(function() {
        function renderTasks(tasks) {
            $("#task-list").empty();

            tasks.forEach(function(task) {
                let taskClass = "task";
                if (task.IsDone) {
                    taskClass += " completed";
                }
                let priorityClass = "";
                if (task.Priority === 1) {
                    priorityClass = "task-priority-high";
                } else if (task.Priority === 2) {
                    priorityClass = "task-priority-medium";
                } else if (task.Priority === 3) {
                    priorityClass = "task-priority-low";
                }

                let taskHTML = `
                    <div class="${taskClass} ${priorityClass}" data-task-id="${task.ID}">
                      <div class="form-check">
                        <input type="checkbox" class="form-check-input" id="task-${task.ID}" ${task.IsDone ? "checked" : ""}>
                        <label class="form-check-label" for="task-${task.ID}">${task.Title}</label>
                      </div>
                      <p>${task.Description}</p>
                      <div class="task-actions">
                        <button class="btn btn-sm btn-primary edit-task" data-task-id="${task.ID}">Изменить</button>
                        <button class="btn btn-sm btn-danger delete-task" data-task-id="${task.ID}">Удалить</button>
                        <select class="form-control priority-select" data-task-id="${task.ID}">
                          <option value="1" ${task.Priority === 1 ? "selected" : ""}>Высокий</option>
                          <option value="2" ${task.Priority === 2 ? "selected" : ""}>Средний</option>
                          <option value="3" ${task.Priority === 3 ? "selected" : ""}>Низкий</option>
                        </select>
                      </div>
                    </div>
                `;
                $("#task-list").append(taskHTML);
            });
        }

        function getTasks(filterStatus, sortOption) {
            let url = "/api/tasks";

            if (filterStatus) {
                url += `?status=${filterStatus}`;
            }

            if (sortOption && sortOption !== "none") {
                url += filterStatus ? `&sort=${sortOption}` : `?sort=${sortOption}`;
            }

            $.ajax({
                url: url,
                type: "GET",
                success: function(data) {
                    renderTasks(data);
                },
                error: function(error) {
                    console.error("Ошибка получения задач:", error);
                }
            });
        }

        function addTask() {
            let title = $("#new-task-title").val();
            let description = $("#new-task-description").val();
            let priority = $("#new-task-priority").val();

            let taskData = {
                Title: title,
                Description: description,
                Priority: parseInt(priority),
                IsDone: false
            };

            $.ajax({
                url: "/api/tasks",
                type: "POST",
                data: JSON.stringify(taskData),
                contentType: "application/json",
                success: function() {
                    $("#new-task-title").val("");
                    $("#new-task-description").val("");
                    getTasks(); // Обновляем список задач
                },
                error: function(error) {
                    console.error("Ошибка добавления задачи:", error);
                }
            });
        }

        function toggleTaskStatus(taskID) {
            $.ajax({
                url: `/api/tasks/toggle?id=${taskID}`,
                type: "PUT",
                success: function() {
                    getTasks(); // Обновляем список задач
                },
                error: function(error) {
                    console.error("Ошибка изменения статуса задачи:", error);
                }
            });
        }

        function deleteTask(taskID) {
            $.ajax({
                url: `/api/tasks/${taskID}`,
                type: "DELETE",
                success: function() {
                    getTasks(); // Обновляем список задач
                },
                error: function(error) {
                    console.error("Ошибка удаления задачи:", error);
                }
            });
        }

        function setTaskPriority(taskID, priority) {
            $.ajax({
                url: `/api/tasks/priority`,
                type: "PUT",
                data: JSON.stringify({
                    ID: taskID,
                    Priority: parseInt(priority)
                }),
                contentType: "application/json",
                success: function() {
                    getTasks(); // Обновляем список задач
                },
                error: function(error) {
                    console.error("Ошибка изменения приоритета задачи:", error);
                }
            });
        }

        $("#add-task").click(addTask);
        $("#refresh-tasks").click(function() {
            getTasks();
        });

        $("#filter-completed").click(function() {
            getTasks("completed");
        });

        $("#filter-not-completed").click(function() {
            getTasks("not_completed");
        });

        $("#filter-all").click(function() {
            getTasks();
        });

        $("#sort-tasks").change(function() {
            let sortOption = $(this).val();
            getTasks(null, sortOption);
        });

        $("#task-list").on("click", "input[type=checkbox]", function() {
            let taskID = $(this).closest(".task").data("task-id");
            toggleTaskStatus(taskID);
        });

        $("#task-list").on("click", ".delete-task", function() {
            let taskID = $(this).data("task-id");
            deleteTask(taskID);
        });

        $("#task-list").on("change", ".priority-select", function() {
            let taskID = $(this).data("task-id");
            let priority = $(this).val();
            setTaskPriority(taskID, priority);
        });

        getTasks(); // Загружаем задачи при первой загрузке страницы
    });
</script>
</body>
</html>
