<!DOCTYPE html>
<html>
<head>
    <title>Todo List</title>
    <style>
        body {
            font-family: sans-serif;
        }
        #container {
            width: 600px;
            margin: 0 auto;
            padding: 20px;
            border: 1px solid #ccc;
        }
        input[type="text"],
        textarea {
            width: 100%;
            padding: 10px;
            margin-bottom: 10px;
            border: 1px solid #ccc;
            box-sizing: border-box;
        }
        button {
            padding: 10px 20px;
            background-color: #4CAF50;
            color: white;
            border: none;
            cursor: pointer;
        }
         {
            border: 1px solid #ccc;
            padding: 10px;
            margin-bottom: 10px;
            background-color: #f2f2f2;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
         {
            font-weight: bold;
        }
         {
            display: flex;
        }
        .task-actions button {
            margin-left: 10px;
        }
         {
            text-decoration: line-through;
            color: #888;
        }
        .filter-options {
            margin-bottom: 20px;
        }
        .sort-options {
            margin-bottom: 20px;
        }
        .priority-options {
            margin-bottom: 20px;
        }
        .priority-options select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ccc;
        }
        .error {
            color: red;
            font-weight: bold;
            margin-bottom: 10px;
        }
    </style>
</head>
<body>
<div id="container">
    <h1>Todo List</h1>

    <div class="filter-options">
        Filter by Status:
        <select id="filterStatus">
            <option value="all">All</option>
            <option value="completed">Completed</option>
            <option value="not completed">Not Completed</option>
        </select>
    </div>

    <div class="sort-options">
        Sort By:
        <select id="sortOption">
            <option value="date">Date</option>
            <option value="status">Status</option>
            <option value="priority">Priority</option>
        </select>
    </div>

    <div class="priority-options">
        Set Priority:
        <select id="priorityOption">
            <option value="1">High</option>
            <option value="2">Medium</option>
            <option value="3">Low</option>
        </select>
    </div>

    <div id="addTaskForm">
        <h2>Add Task</h2>
        <input type="text" id="taskTitle" placeholder="Task Title">
        <textarea id="taskDescription" placeholder="Description"></textarea>
        <button id="addTaskBtn">Add Task</button>
        <div id="addTaskError" class="error"></div>
    </div>

    <div id="taskList">
        <h2>Tasks</h2>
        <ul id="tasks"></ul>
    </div>

    <script>
        const tasksList = document.getElementById("tasks");
        const addTaskForm = document.getElementById("addTaskForm");
        const addTaskBtn = document.getElementById("addTaskBtn");
        const taskTitleInput = document.getElementById("taskTitle");
        const taskDescriptionInput = document.getElementById("taskDescription");
        const filterStatusSelect = document.getElementById("filterStatus");
        const sortOptionSelect = document.getElementById("sortOption");
        const priorityOptionSelect = document.getElementById("priorityOption");
        const addTaskError = document.getElementById("addTaskError");

        fetchTasks();

        addTaskBtn.addEventListener("click", addTask);

        filterStatusSelect.addEventListener("change", fetchTasks);

        sortOptionSelect.addEventListener("change", fetchTasks);

        async function fetchTasks() {
            let filterStatus = filterStatusSelect.value;
            let sortOption = sortOptionSelect.value;

            let url = "/tasks";

            if (filterStatus !== "all") {
                url += "?status=" + filterStatus;
            }

            if (sortOption !== "") {
                if (filterStatus !== "all") {
                    url += "&";
                }
                url += "option=" + sortOption;
            }

            try {
                const response = await fetch(url);
                const tasks = await response.json();
                renderTasks(tasks);
            } catch (error) {
                console.error("Error fetching tasks:", error);
            }
        }

        function renderTasks(tasks) {
            tasksList.innerHTML = "";
            tasks.forEach(task => {
                const taskItem = document.createElement("li");
                taskItem.classList.add("task");

                const taskTitle = document.createElement("span");
                taskTitle.classList.add("task-title");
                taskTitle.textContent = task.Title;
                if (task.IsDone) {
                    taskTitle.classList.add("task-done");
                }

                const taskActions = document.createElement("div");
                taskActions.classList.add("task-actions");

                const toggleBtn = document.createElement("button");
                toggleBtn.textContent = task.IsDone ? "Mark as Not Done" : "Mark as Done";
                toggleBtn.addEventListener("click", () => toggleTaskStatus(task.ID));
                taskActions.appendChild(toggleBtn);

                const editBtn = document.createElement("button");
                editBtn.textContent = "Edit";
                editBtn.addEventListener("click", () => editTask(task));
                taskActions.appendChild(editBtn);

                const deleteBtn = document.createElement("button");
                deleteBtn.textContent = "Delete";
                deleteBtn.addEventListener("click", () => deleteTask(task.ID));
                taskActions.appendChild(deleteBtn);


                const priorityBtn = document.createElement("button");
                priorityBtn.textContent = "Set Priority";
                priorityBtn.addEventListener("click", () => setPriority(task));
                taskActions.appendChild(priorityBtn);

                taskItem.appendChild(taskTitle);
                taskItem.appendChild(taskActions);
                tasksList.appendChild(taskItem);
            });
        }


        async function addTask() {
            const title = taskTitleInput.value.trim();
            const description = taskDescriptionInput.value.trim();
            if (title === "") {
                addTaskError.textContent = "Please enter a task title";
                return;
            }
            addTaskError.textContent = "";

            const newTask = {
                Title: title,
                Description: description
            };

            try {
                const response = await fetch("/tasks", {
                    method: "POST",
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(newTask)
                });

                if (response.ok) {
                    taskTitleInput.value = "";
                    taskDescriptionInput.value = "";
                    fetchTasks();
                } else {
                    const errorData = await response.json();
                    addTaskError.textContent = errorData.error || "Error adding task";
                }
            } catch (error) {
                console.error("Error adding task:", error);
            }
        }


        async function toggleTaskStatus(taskID) {
            try {
                const response = await fetch(`/tasks/${taskID}/toggle`, {
                    method: "PUT"
                });

                if (response.ok) {
                    fetchTasks();
                } else {
                    console.error("Error toggling task status:", response.statusText);
                }
            } catch (error) {
                console.error("Error toggling task status:", error);
            }
        }


        async function editTask(task) {

            let updatedTitle = prompt("Edit Task Title:", task.Title);
            let updatedDescription = prompt("Edit Task Description:", task.Description);


            if (updatedTitle !== null && updatedTitle !== task.Title) {
                task.Title = updatedTitle;
            }
            if (updatedDescription !== null && updatedDescription !== task.Description) {
                task.Description = updatedDescription;
            }

            try {
                const response = await fetch(`/tasks/${task.ID}`, {
                    method: "PUT",
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(task)
                });

                if (response.ok) {
                    fetchTasks();
                } else {
                    console.error("Error editing task:", response.statusText);
                }
            } catch (error) {
                console.error("Error editing task:", error);
            }
        }

        async function deleteTask(taskID) {
            if (confirm(`Are you sure you want to delete this task?`)) {
                try {
                    const response = await fetch(`/tasks/${taskID}`, {
                        method: "DELETE"
                    });

                    if (response.ok) {
                        fetchTasks();
                    } else {
                        console.error("Error deleting task:", response.statusText);
                    }
                } catch (error) {
                    console.error("Error deleting task:", error);
                }
            }
        }

        async function setPriority(task) {
            const priority = priorityOptionSelect.value;
            try {
                const response = await fetch(`/tasks/${task.ID}/priority`, {
                    method: "PUT",
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        id: task.ID,
                        priority: priority
                    })
                });

                if (response.ok) {
                    fetchTasks();
                } else {
                    console.error("Error setting priority:", response.statusText);
                }
            } catch (error) {
                console.error("Error setting priority:", error);
            }
        }

        async function insertTestData() {
            try {
                const response = await fetch("/tasks/test-data", {
                    method: "POST"
                });

                if (response.ok) {
                    alert("Test data inserted successfully!");
                    fetchTasks();
                } else {
                    console.error("Error inserting test data:", response.statusText);
                }
            } catch (error) {
                console.error("Error inserting test data:", error);
            }
        }

        const insertTestDataBtn = document.createElement("button");
        insertTestDataBtn.textContent = "Insert Test Data";
        insertTestDataBtn.addEventListener("click", insertTestData);
        document.getElementById("container").appendChild(insertTestDataBtn);
    </script>
</div>
</body>
</html>